services:
  # OAuth 2.1 + API key authentication
  auth-service:
    image: ghcr.io/webdesserts/auth-service:${VERSION:-latest}
    build:
      context: ..
      dockerfile: docker/Dockerfile.auth
    volumes:
      - auth-config:/config
    environment:
      - RUST_LOG=info,auth_service=debug
      - AUTH_CONFIG_PATH=/config
      - AUTH_PUBLIC_URL=https://${DOMAIN:-leda.webdesserts.com}/auth
      - AUTH_PATH_PREFIX=/auth
    expose:
      - "3001"
    restart: unless-stopped
    mem_limit: 48m
    memswap_limit: 48m
    mem_reservation: 16m
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # MCP server with HTTP transport
  memory:
    image: ghcr.io/webdesserts/memory:${VERSION:-latest}
    build:
      context: ..
      dockerfile: docker/Dockerfile.memory
    volumes:
      - notes:/notes:rw
    environment:
      - OBSIDIAN_VAULT_PATH=/notes
      - RUST_LOG=info,memory=debug
    expose:
      - "3000"
    depends_on:
      - auth-service
    restart: unless-stopped
    mem_limit: 1280m
    memswap_limit: 1280m
    mem_reservation: 128m
    oom_score_adj: 300  # Kill first - can recover, is the memory hog
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # P2P vault sync daemon
  sync-daemon:
    image: ghcr.io/webdesserts/sync-daemon:${VERSION:-latest}
    build:
      context: ..
      dockerfile: docker/Dockerfile.sync
    volumes:
      - notes:/notes:rw
    environment:
      - RUST_LOG=info,sync_daemon=debug
    expose:
      - "8080"
    restart: unless-stopped
    mem_limit: 64m
    memswap_limit: 64m
    mem_reservation: 32m
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # TLS termination + routing
  caddy:
    image: caddy:2-alpine
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN:-leda.webdesserts.com}
    depends_on:
      - auth-service
      - memory
      - sync-daemon
    restart: unless-stopped
    mem_limit: 64m
    memswap_limit: 64m
    mem_reservation: 16m
    oom_score_adj: -300  # Protect gateway - if it dies, nothing is reachable
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  # Vault data - bind mount to host directory
  notes:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${NOTES_PATH:?NOTES_PATH must be set to vault directory}

  # Persistent config for auth service (tokens, clients, API keys)
  auth-config:

  # Caddy TLS certificates and config
  caddy-data:
  caddy-config:
